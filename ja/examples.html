<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <meta http-equiv="X-UA-Compatible" content="chrome=1" />
  <meta name="description" content="q : q - Text as Data" />

  <link rel="stylesheet" type="text/css" media="screen" href="../stylesheets/stylesheet.css">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

  <title>使用例</title>
  <script type="text/javascript" src="../javascripts/google-analytics.js"></script>
</head>

<body>

  <!-- HEADER -->
  <div id="header_wrap" class="outer">
    <header class="inner">
      <select id="language_switcher" onChange="window.location.href=this.value">
        <option value="../index.html">English</option>
        <option value="ja/index.html" selected>Japanese</option>
      </select>
      <img id="q-logo" src="../images/q-logo1.png"/>
      <a id="forkme_banner" href="https://github.com/harelba/q">View on GitHub</a>

      <h1 id="project_title">q</h1>
      <h2 id="project_tagline">q - Text as Data</h2>


      <iframe src="http://ghbtns.com/github-btn.html?user=harelba&repo=q&type=watch&count=true&size=large"  allowtransparency="true" frameborder="0" scrolling="0" width="170" height="30"></iframe>

      <section id="downloads">
        <a class="zip_download_link" download href="https://github.com/harelba/q/archive/1.6.3.zip">Download the last stable version zip file </a>
        <a class="tar_download_link" download href="https://github.com/harelba/q/archive/1.6.3.tar.gz">Download the last stable version tar.gz file</a>
        <a class="rpm_download_link" download href="https://github.com/harelba/packages-for-q/raw/master/rpms/q-text-as-data-1.6.3-1.noarch.rpm">Download the latest stable version RPM</a>
        <a class="deb_download_link" download href="https://github.com/harelba/packages-for-q/raw/master/deb/q-text-as-data_1.6.3-2_all.deb">Download the latest stable version Debian package</a>
        <a class="executable_download_link" title="Single file executable, for systems with python installed" href="https://cdn.rawgit.com/harelba/q/1.6.3/bin/q">Download the single-file executable</a>
        <a class="windows_download_link" title="Beta installation for Windows systems. Adds q.exe to the path. Please send me any comments" href="https://github.com/harelba/packages-for-q/raw/master/windows/setup-q-1.6.3.exe">Download the single-file executable</a>
      </section>
    </header>
  </div>

  <div id="sidenav">
    <h1 id="general">一般</h1>
    <ul>
      <li><a href="index.html">ホーム</a></li>
      <li><a href="install.html">ダウンロードとインストール</a></li>
      <li><a href="requirements.html">動作条件</a></li>
      <li><a href="limitations.html">制約</a></li>
      <li><a href="future-ideas.html">将来のアイデア</a></li>
    </ul>
    <h1 id="documentation">ドキュメント</h1>
    <ul>
      <li><a href="usage.html">使い方</a></li>
      <li><a href="examples.html">使用例</a></li>
      <li><a href="tutorial.html">チュートリアル</a></li>
    </ul>
    <h1 id="other">舞台裏</h1>
    <ul>
      <li><a href="changelog.html">更新履歴</a></li>
      <li><a href="implementation.html">実装</a></li>
      <li><a href="rationale.html">設計原理</a></li>
    </ul>
    <h1 id="author">作者</h1>
    <ul>
      <li><a href="contact.html">連絡先</a><br/>Twitter: <a href="https://twitter.com/harelba">@harelba</a><br/>Email: <a href="mailto:harelba@gmail.com">harelba@gmail.com</a></li>
    </ul>
    <h1 id="social">Social</h1>
    <ul>
      <li>Twitter: <a target="_blank" href="https://twitter.com/search?f=realtime&q=%23qtextasdata&src=typd">#qtextasdata</a></li>
    </ul>
  </div>
  <!-- MAIN CONTENT -->
  <div id="main_content_wrap" class="outer">
    <div id="main_content" class="inner">
      <h2>使用例</h2>
      <p>下の例の中で使用している <code>-H</code> フラグはカラムを名付けるために使われるヘッダーの列があることを意味しています。</p>
      <p><code>-t</code> 単にファイルが、タブ区切りのファイルであることを認識させるためのショートカットです。 (どんなデリミタもサポートしています - <code>-d</code> フラグを使ってください).</p>

      <p>クエリはわかりやすさのために大文字で記載していますが、実際には大文字小文字どちらでも構いません。</p>

      <ul>
        <li>使用例</li>
        <ul>
          <li><a href="#example1">例 1 - 特定のフィールドを COUNT DISTINCT した値 (クリックデータの uuid)</a></li>
          <li><a href="#example2">例 2 - 数字データでのフィルタ、 ORDER と LIMIT を使った制御</a></li>
          <li><a href="#example3">例 3 - GROUP BY の解説</a></li>
          <li><a href="#example4">例 4 - より複雑な GROUP BY (time 表現をつかった group by)</a></li>
          <li><a href="#example5">例 5 - 標準入力からの入力</a></li>
          <li><a href="#example6">例 6 - ヘッダー列をカラム名として使う</a></li>
          <li><a href="#example7">例 7 - 2 つのファイルを JOIN する</a></li>
        </ul>
      </ul>

      <br/><br/>

      <p><strong><a name="example1"></a>例 1 - 特定のフィールドを COUNT DISTINCT した値 (クリックデータの uuid)</strong></p>

      <pre class="code_example_wrapper"><code class="code_example">q -H -t "SELECT COUNT(DISTINCT(uuid)) FROM ./clicks.csv"
      </code></pre>

      <p><strong>出力 1:</strong></p>

      <div class="highlight highlight-bash"><pre class="code_example">229
      </pre></div>

      <br/><br/>

      <p><strong><a name="example2"></a>数字データでのフィルタ、 ORDER と LIMIT を使った制御</strong></p>

      <p><code>q</code> はカラムが数値型と理解し、その数に応じてフィルタします。 (文字列比較ではなく、本当の数値比較).</p>

      <pre class="code_example_wrapper"><code class="code_example">q -H -t "SELECT request_id,score FROM ./clicks.csv WHERE score &gt; 0.7 ORDER BY score DESC LIMIT 5"
      </code></pre>

      <p><strong>出力 2:</strong></p>

      <div class="highlight highlight-bash"><pre class="code_example_wrapper code_example">2cfab5ceca922a1a2179dc4687a3b26e    1.0
        f6de737b5aa2c46a3db3208413a54d64    0.986665809568
        766025d25479b95a224bd614141feee5    0.977105183282
        2c09058a1b82c6dbcf9dc463e73eddd2    0.703255121794
      </pre></div>

      <br/><br/>

      <p><strong><a name="example3"></a>例 3 - GROUP BY の解説</strong></p>

      <pre class="code_example_wrapper"><code class="code_example">q -t -H "SELECT hashed_source_machine,count(*) FROM ./clicks.csv GROUP BY hashed_source_machine"
      </code></pre>

      <p><strong>出力 3:</strong></p>

      <div class="highlight highlight-bash"><pre class="code_example_wrapper code_example">47d9087db433b9ba.domain.com 400000
      </pre></div>

      <br/><br/>

      <p><strong><a name="example4"></a>より複雑な GROUP BY (time 表現をつかった group by)</strong></p>

      <pre class="code_example_wrapper"><code class="code_example">q -t -H "SELECT strftime('%H:%M',date_time) hour_and_minute,count(*) FROM ./clicks.csv GROUP BY hour_and_minute"
      </code></pre>

      <p><strong>出力 4:</strong></p>

      <div class="highlight highlight-bash"><pre class="code_example_wrapper code_example">07:00   138148
        07:01   140026
        07:02   121826
      </pre></div>

      <br/><br/>
      <p><strong><a name="example5"></a>例 5 - 標準入力からの入力</strong></p>

      <p>/tmp サブツリー内の、ユーザとグループごとに MB 単位で合計サイズを表示します。</p>

      <pre class="code_example_wrapper"><code class="code_example">sudo find /tmp -ls | q "SELECT c5,c6,sum(c7)/1024.0/1024 AS total FROM - GROUP BY c5,c6 ORDER BY total desc"
      </code></pre>

      <p><strong>出力 5:</strong></p>

      <div class="highlight highlight-bash"><pre class="code_example_wrapper code_example">mapred hadoop   304.00390625
        root   root     8.0431451797485
        smith  smith    4.34389972687
      </pre></div>

      <br/><br/>
      <p><strong><a name="example6"></a>例 6 - ヘッダー列をカラム名として使う</strong></p>

      <p>最もたくさんプロセスを所有しているトップ 3 のユーザ ID を計算し、降順で表示します。</p>
      <p>クエリ内で使用している UID というカラム名は自動検出されています。</p>

      <pre class="code_example_wrapper"><code class="code_example">ps -ef | q -H "SELECT UID,COUNT(*) cnt FROM - GROUP BY UID ORDER BY cnt DESC LIMIT 3"
      </code></pre>

      <p><strong>出力 6:</strong></p>

      <div class="highlight highlight-bash"><pre class="code_example_wrapper code_example">root 152
        harel 119
        avahi 2
      </pre></div>



      <br/><br/>
      <p><strong><a name="example7"></a>例 7 - 2 つのファイルを JOIN する</strong></p>

      <p>以下のコマンドは ls のアウトプット (<a href="https://cdn.rawgit.com/harelba/q/1.6.3/examples/exampledatafile">exampledatafile</a>) とグループ名とEメールの列を含むファイル (<a href="https://cdn.rawgit.com/harelba/q/1.6.3/examples/group-emails-example">group-emails-example</a>) を JOIN して、ファイル名と、グループに紐付く各emailに対応するemailの列を提供します。 出力を簡潔にするために WHERE 節を使って実現される ppp と呼ばれる具体的なファイル名でフィルタリングも行っている。
      </p>

      <pre class="code_example_wrapper"><code class="code_example">q "SELECT myfiles.c8,emails.c2 FROM exampledatafile myfiles JOIN group-emails-example emails ON (myfiles.c4 = emails.c1) WHERE myfiles.c8 = 'ppp'"
      </code></pre>

      <p><strong>出力 7:</strong></p>

      <div class="highlight highlight-bash"><pre class="code_example_wrapper code_example">ppp dip.1@otherdomain.com
        ppp dip.2@otherdomain.com
      </pre></div>

      <p>email が紐付いているグループディップの email のうちの1つにマッチするたびに、<code>ppp</code> ファイル名が2回出現していることがわかると思います。
        <code>exampledatafile</code> と <code>group-emails-example</code> を見て確認してみてください。</p>

        <p>カラム名検出は JOIN 使用時もサポートされています。読み込み元ファイルのヘッダ列にカラム名が存在することを確認した上で、<code>-H</code> オプションを指定してください。</p>

      </body>
      </html>
